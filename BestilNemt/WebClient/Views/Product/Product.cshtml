@using WebClient.BestilNemtServiceRef
@model List<Product>
@{
    ViewBag.Title = "Product";
}

<script>
    function myFunction() {
        // Declare variables
        var input, filter, table, tr, td, i;
        input = document.getElementById("MyInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("ProductTable");
        tr = table.getElementsByTagName("tr");

        // Loop through all table rows, and hide those who don't match the search query
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1];
            if (td) {
                if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
@{
    var shop = (Shop)Session["Shop"];
    if (shop != null)
    {
        <h2>Alle produkter i @shop.Name - @shop.Address</h2>
    }
}

<input type="text" id="MyInput" onkeyup="myFunction()" placeholder="Search for names.." title="Type in a name">

@{
    if (@Model.Count > 0)
    {
        <table id="ProductTable">
            <tr>
                <th></th>
                <th>Navn</th>
                <th>Beskrivelse</th>
                <th>Antal på lager</th>
                <th>Pris</th>
            </tr>
            @foreach (var product in Model)
                {
                <tr>
                    <td>
                        <img src="/Images/ProductPictures/@product.ImgPath" height="50" width="50" alt="@product.Name">
                    </td>
                    <td><a href="/Product/ProductPage/@product.Id">@product.Name</a></td>
                    <td>@product.Description</td>
                    @{
                        var isFound = false;
                        if (shop?.Warehouses.Count > 0)
                        {
                            foreach (var warehouse in shop.Warehouses)
                            {
                                if (warehouse.Product.Id == product.Id)
                                {
                                    isFound = true;
                                    var stock = warehouse.Stock;
                                    if (stock > 100)
                                    {
                                        stock = 100;
                                        W‌riteLiteral(@"<td>"); /*​*/
                                        W‌rite(stock); /*​*/
                                        W‌riteLiteral(@"+</td>");
                                    }
                                    else
                                    {
                                        W‌riteLiteral(@"<td>"); /*​*/
                                        W‌rite(stock); /*​*/
                                        W‌riteLiteral(@"</td>");
                                    }
                                }
                            }
                        }
                        if (!isFound)
                        {
                            <td>0</td>
                        }
                        var proxy = new BestilNemtServiceClient();
                        if (shop == null)
                        {
                            shop = new Shop();
                        }
                        var warehouse2 = proxy.GetWarehouseByProductId(product.Id, shop.Id);
                        var savingId = warehouse2.SavingId;
                        var price = product.Price;
                        if (savingId != null)
                        {
                            var saving = proxy.GetSaving(savingId.Value);
                            if (saving != null)
                            {
                                var percent = (decimal)saving.SavingPercent;
                                var newPrice = price - (price * percent / 100);
                                <td>@price kr - @percent % = @newPrice kr</td>
                            }
                            else
                            {
                                <td>@price kr</td>
                            }

                        }
                        else
                        {
                            <td>@price kr</td>
                        }
                    }
                </tr>
                        }
        </table>
                        }
}